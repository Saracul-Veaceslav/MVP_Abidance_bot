# 4. Database Schema

This section details the database schema design for the Abidance trading bot. The system uses TimescaleDB (PostgreSQL extension) for efficient time-series data storage, particularly for market data.

## 4.1 Market Data Tables

### 4.1.1 `candlesticks` Table
Stores OHLCV (Open, High, Low, Close, Volume) data at different timeframes.

```sql
CREATE TABLE candlesticks (
    id SERIAL PRIMARY KEY,
    symbol VARCHAR(20) NOT NULL,
    timeframe VARCHAR(10) NOT NULL,
    timestamp TIMESTAMPTZ NOT NULL,
    open DECIMAL(24, 8) NOT NULL,
    high DECIMAL(24, 8) NOT NULL,
    low DECIMAL(24, 8) NOT NULL,
    close DECIMAL(24, 8) NOT NULL,
    volume DECIMAL(36, 8) NOT NULL,
    num_trades INTEGER,
    taker_buy_base_volume DECIMAL(36, 8),
    taker_buy_quote_volume DECIMAL(36, 8),
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    UNIQUE (symbol, timeframe, timestamp)
);

-- Convert to TimescaleDB hypertable for time-series optimization
SELECT create_hypertable('candlesticks', 'timestamp');

-- Create indexes for efficient queries
CREATE INDEX idx_candlesticks_symbol_timeframe ON candlesticks (symbol, timeframe);
CREATE INDEX idx_candlesticks_timestamp ON candlesticks (timestamp DESC);
```

### 4.1.2 `order_book_snapshots` Table
Stores periodic snapshots of the order book for each trading pair.

```sql
CREATE TABLE order_book_snapshots (
    id SERIAL PRIMARY KEY,
    symbol VARCHAR(20) NOT NULL,
    timestamp TIMESTAMPTZ NOT NULL,
    bids JSONB NOT NULL, -- Array of [price, quantity] pairs
    asks JSONB NOT NULL, -- Array of [price, quantity] pairs
    last_update_id BIGINT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    UNIQUE (symbol, timestamp)
);

-- Convert to TimescaleDB hypertable
SELECT create_hypertable('order_book_snapshots', 'timestamp');

-- Create indexes
CREATE INDEX idx_order_book_snapshots_symbol ON order_book_snapshots (symbol);
CREATE INDEX idx_order_book_snapshots_timestamp ON order_book_snapshots (timestamp DESC);
```

### 4.1.3 `technical_indicators` Table
Stores pre-calculated technical indicators for each trading pair and timeframe.

```sql
CREATE TABLE technical_indicators (
    id SERIAL PRIMARY KEY,
    symbol VARCHAR(20) NOT NULL,
    timeframe VARCHAR(10) NOT NULL,
    timestamp TIMESTAMPTZ NOT NULL,
    indicator_name VARCHAR(50) NOT NULL,
    value DECIMAL(24, 8) NOT NULL,
    parameters JSONB, -- Store indicator-specific parameters
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    UNIQUE (symbol, timeframe, timestamp, indicator_name, parameters)
);

-- Convert to TimescaleDB hypertable
SELECT create_hypertable('technical_indicators', 'timestamp');

-- Create indexes
CREATE INDEX idx_technical_indicators_lookup ON technical_indicators (symbol, timeframe, indicator_name);
CREATE INDEX idx_technical_indicators_timestamp ON technical_indicators (timestamp DESC);
```

## 4.2 Strategy Management Tables

### 4.2.1 `strategies` Table
Stores trading strategy configurations.

```sql
CREATE TYPE strategy_type AS ENUM ('trend_following', 'mean_reversion', 'ml_based');
CREATE TYPE strategy_status AS ENUM ('active', 'inactive', 'testing', 'error');

CREATE TABLE strategies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    type strategy_type NOT NULL,
    status strategy_status DEFAULT 'inactive',
    parameters JSONB NOT NULL, -- Strategy-specific parameters
    symbols JSONB NOT NULL, -- Array of trading pairs this strategy applies to
    timeframes JSONB NOT NULL, -- Array of timeframes this strategy uses
    risk_parameters JSONB NOT NULL, -- Risk management parameters
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    last_run_at TIMESTAMPTZ,
    performance_metrics JSONB, -- Cached performance metrics
    UNIQUE (name)
);

-- Create indexes
CREATE INDEX idx_strategies_type_status ON strategies (type, status);
```

### 4.2.2 `strategy_signals` Table
Stores signals generated by trading strategies.

```sql
CREATE TYPE signal_type AS ENUM ('buy', 'sell', 'exit', 'adjust');

CREATE TABLE strategy_signals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    strategy_id UUID NOT NULL REFERENCES strategies(id) ON DELETE CASCADE,
    symbol VARCHAR(20) NOT NULL,
    timestamp TIMESTAMPTZ NOT NULL,
    signal_type signal_type NOT NULL,
    price DECIMAL(24, 8) NOT NULL,
    confidence DECIMAL(5, 4), -- Optional confidence score (0-1)
    parameters JSONB, -- Signal-specific parameters
    indicators_snapshot JSONB, -- Snapshot of indicators that led to this signal
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    processed BOOLEAN DEFAULT FALSE,
    execution_id UUID, -- Link to the trade execution if processed
    UNIQUE (strategy_id, symbol, timestamp, signal_type)
);

-- Convert to TimescaleDB hypertable
SELECT create_hypertable('strategy_signals', 'timestamp');

-- Create indexes
CREATE INDEX idx_strategy_signals_strategy ON strategy_signals (strategy_id);
CREATE INDEX idx_strategy_signals_lookup ON strategy_signals (symbol, processed);
CREATE INDEX idx_strategy_signals_timestamp ON strategy_signals (timestamp DESC);
```

## 4.3 Trade Execution Tables

### 4.3.1 `positions` Table
Tracks open trading positions.

```sql
CREATE TYPE position_status AS ENUM ('open', 'closed', 'partially_closed');
CREATE TYPE position_direction AS ENUM ('long', 'short');

CREATE TABLE positions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    strategy_id UUID NOT NULL REFERENCES strategies(id),
    symbol VARCHAR(20) NOT NULL,
    direction position_direction NOT NULL,
    status position_status DEFAULT 'open',
    entry_price DECIMAL(24, 8) NOT NULL,
    current_price DECIMAL(24, 8) NOT NULL,
    size DECIMAL(24, 8) NOT NULL,
    remaining_size DECIMAL(24, 8) NOT NULL, -- For partially closed positions
    entry_time TIMESTAMPTZ NOT NULL,
    exit_time TIMESTAMPTZ,
    stop_loss DECIMAL(24, 8),
    take_profit JSONB, -- Array of take-profit levels
    trailing_stop JSONB, -- Trailing stop parameters
    unrealized_pnl DECIMAL(24, 8),
    realized_pnl DECIMAL(24, 8) DEFAULT 0,
    fee_paid DECIMAL(24, 8) DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- Create indexes
CREATE INDEX idx_positions_strategy ON positions (strategy_id);
CREATE INDEX idx_positions_symbol_status ON positions (symbol, status);
CREATE INDEX idx_positions_entry_time ON positions (entry_time DESC);
```

### 4.3.2 `orders` Table
Tracks order placement and execution.

```sql
CREATE TYPE order_type AS ENUM ('market', 'limit', 'stop', 'stop_limit', 'trailing_stop');
CREATE TYPE order_side AS ENUM ('buy', 'sell');
CREATE TYPE order_status AS ENUM ('new', 'partially_filled', 'filled', 'canceled', 'rejected', 'expired');

CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    position_id UUID REFERENCES positions(id) ON DELETE SET NULL,
    strategy_id UUID NOT NULL REFERENCES strategies(id),
    symbol VARCHAR(20) NOT NULL,
    exchange_order_id VARCHAR(100),
    type order_type NOT NULL,
    side order_side NOT NULL,
    status order_status NOT NULL,
    price DECIMAL(24, 8),
    stop_price DECIMAL(24, 8),
    size DECIMAL(24, 8) NOT NULL,
    filled_size DECIMAL(24, 8) DEFAULT 0,
    remaining_size DECIMAL(24, 8),
    average_fill_price DECIMAL(24, 8),
    fee_paid DECIMAL(24, 8) DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    closed_at TIMESTAMPTZ,
    is_paper_trade BOOLEAN DEFAULT FALSE
);

-- Create indexes
CREATE INDEX idx_orders_position ON orders (position_id);
CREATE INDEX idx_orders_strategy ON orders (strategy_id);
CREATE INDEX idx_orders_symbol_status ON orders (symbol, status);
CREATE INDEX idx_orders_created_at ON orders (created_at DESC);
```

### 4.3.3 `trades` Table
Records individual trade executions (fills).

```sql
CREATE TABLE trades (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
    position_id UUID REFERENCES positions(id) ON DELETE SET NULL,
    exchange_trade_id VARCHAR(100),
    symbol VARCHAR(20) NOT NULL,
    price DECIMAL(24, 8) NOT NULL,
    size DECIMAL(24, 8) NOT NULL,
    fee DECIMAL(24, 8) NOT NULL,
    fee_currency VARCHAR(10) NOT NULL,
    side order_side NOT NULL,
    timestamp TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    is_paper_trade BOOLEAN DEFAULT FALSE
);

-- Create indexes
CREATE INDEX idx_trades_order ON trades (order_id);
CREATE INDEX idx_trades_position ON trades (position_id);
CREATE INDEX idx_trades_timestamp ON trades (timestamp DESC);
```

## 4.4 Performance Tracking Tables

### 4.4.1 `equity_snapshots` Table
Tracks account equity over time.

```sql
CREATE TABLE equity_snapshots (
    id SERIAL PRIMARY KEY,
    timestamp TIMESTAMPTZ NOT NULL,
    total_equity DECIMAL(24, 8) NOT NULL,
    available_balance DECIMAL(24, 8) NOT NULL,
    allocated_in_positions DECIMAL(24, 8) NOT NULL,
    open_position_count INTEGER NOT NULL,
    unrealized_pnl DECIMAL(24, 8) NOT NULL,
    realized_daily_pnl DECIMAL(24, 8) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- Convert to TimescaleDB hypertable
SELECT create_hypertable('equity_snapshots', 'timestamp');

-- Create indexes
CREATE INDEX idx_equity_snapshots_timestamp ON equity_snapshots (timestamp DESC);
```

### 4.4.2 `strategy_performance` Table
Tracks performance metrics for each strategy.

```sql
CREATE TABLE strategy_performance (
    id SERIAL PRIMARY KEY,
    strategy_id UUID NOT NULL REFERENCES strategies(id) ON DELETE CASCADE,
    timestamp TIMESTAMPTZ NOT NULL,
    timeframe VARCHAR(20) NOT NULL, -- 'daily', 'weekly', 'monthly', 'all_time'
    win_count INTEGER NOT NULL,
    loss_count INTEGER NOT NULL,
    win_rate DECIMAL(5, 4),
    profit_factor DECIMAL(10, 4),
    sharpe_ratio DECIMAL(8, 4),
    sortino_ratio DECIMAL(8, 4),
    max_drawdown DECIMAL(5, 4),
    max_drawdown_duration INTEGER, -- In days
    total_return DECIMAL(10, 4),
    annualized_return DECIMAL(8, 4),
    volatility DECIMAL(8, 4),
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    UNIQUE (strategy_id, timeframe, timestamp)
);

-- Create indexes
CREATE INDEX idx_strategy_performance_strategy ON strategy_performance (strategy_id);
CREATE INDEX idx_strategy_performance_timestamp ON strategy_performance (timestamp DESC);
```

### 4.4.3 `system_metrics` Table
Tracks system performance metrics.

```sql
CREATE TABLE system_metrics (
    id SERIAL PRIMARY KEY,
    timestamp TIMESTAMPTZ NOT NULL,
    cpu_usage DECIMAL(5, 2) NOT NULL, -- Percentage
    memory_usage DECIMAL(5, 2) NOT NULL, -- Percentage
    disk_usage DECIMAL(5, 2) NOT NULL, -- Percentage
    network_sent_bytes BIGINT NOT NULL,
    network_received_bytes BIGINT NOT NULL,
    execution_latency INTEGER NOT NULL, -- In milliseconds
    api_request_count INTEGER NOT NULL,
    api_error_count INTEGER NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- Convert to TimescaleDB hypertable
SELECT create_hypertable('system_metrics', 'timestamp');

-- Create indexes
CREATE INDEX idx_system_metrics_timestamp ON system_metrics (timestamp DESC);
```

## 4.5 Configuration Tables

### 4.5.1 `system_settings` Table
Stores global system configuration.

```sql
CREATE TABLE system_settings (
    id SERIAL PRIMARY KEY,
    key VARCHAR(100) NOT NULL,
    value JSONB NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    UNIQUE (key)
);
```

### 4.5.2 `api_keys` Table
Securely stores API keys for exchanges (encrypted).

```sql
CREATE TABLE api_keys (
    id SERIAL PRIMARY KEY,
    exchange VARCHAR(50) NOT NULL,
    label VARCHAR(100) NOT NULL,
    api_key_encrypted BYTEA NOT NULL,
    api_secret_encrypted BYTEA NOT NULL,
    is_testnet BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    permissions JSONB NOT NULL, -- Specific permissions enabled for this API key
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    last_used_at TIMESTAMPTZ,
    UNIQUE (exchange, label)
);
```

### 4.5.3 `watched_symbols` Table
Tracks which trading pairs are being monitored.

```sql
CREATE TABLE watched_symbols (
    id SERIAL PRIMARY KEY,
    symbol VARCHAR(20) NOT NULL,
    base_asset VARCHAR(10) NOT NULL,
    quote_asset VARCHAR(10) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    timeframes JSONB NOT NULL, -- Array of timeframes being tracked
    price_precision INTEGER NOT NULL,
    quantity_precision INTEGER NOT NULL,
    min_notional DECIMAL(24, 8) NOT NULL,
    min_quantity DECIMAL(24, 8) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    UNIQUE (symbol)
);

-- Create indexes
CREATE INDEX idx_watched_symbols_active ON watched_symbols (is_active);
```

## 4.6 Machine Learning Support Tables

### 4.6.1 `ml_models` Table
Tracks machine learning models.

```sql
CREATE TYPE model_status AS ENUM ('training', 'ready', 'failed', 'archived');
CREATE TYPE model_type AS ENUM ('classification', 'regression', 'reinforcement_learning');

CREATE TABLE ml_models (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    type model_type NOT NULL,
    status model_status DEFAULT 'training',
    framework VARCHAR(50) NOT NULL, -- 'pytorch', 'tensorflow', etc.
    version VARCHAR(20) NOT NULL,
    hyper_parameters JSONB NOT NULL,
    training_metrics JSONB,
    validation_metrics JSONB,
    features_list JSONB NOT NULL, -- List of features used
    symbols JSONB NOT NULL, -- Training data markets
    timeframes JSONB NOT NULL, -- Training data timeframes
    training_start_date TIMESTAMPTZ NOT NULL,
    training_end_date TIMESTAMPTZ NOT NULL,
    file_path VARCHAR(255), -- Path to model files in storage
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    UNIQUE (name, version)
);

-- Create indexes
CREATE INDEX idx_ml_models_status ON ml_models (status);
CREATE INDEX idx_ml_models_type ON ml_models (type);
```

### 4.6.2 `model_predictions` Table
Stores predictions made by ML models.

```sql
CREATE TABLE model_predictions (
    id SERIAL PRIMARY KEY,
    model_id UUID NOT NULL REFERENCES ml_models(id) ON DELETE CASCADE,
    symbol VARCHAR(20) NOT NULL,
    timestamp TIMESTAMPTZ NOT NULL,
    prediction_type VARCHAR(50) NOT NULL, -- 'price_direction', 'next_price', etc.
    prediction_value DECIMAL(24, 8) NOT NULL,
    confidence DECIMAL(5, 4),
    features_snapshot JSONB, -- Snapshot of input features
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    actual_value DECIMAL(24, 8), -- Populated after the actual outcome is known
    prediction_error DECIMAL(24, 8), -- Calculated after actual value is known
    UNIQUE (model_id, symbol, timestamp, prediction_type)
);

-- Convert to TimescaleDB hypertable
SELECT create_hypertable('model_predictions', 'timestamp');

-- Create indexes
CREATE INDEX idx_model_predictions_model ON model_predictions (model_id);
CREATE INDEX idx_model_predictions_symbol ON model_predictions (symbol);
CREATE INDEX idx_model_predictions_timestamp ON model_predictions (timestamp DESC);
```

## 4.7 Logging and Monitoring Tables

### 4.7.1 `system_logs` Table
Stores system logs.

```sql
CREATE TYPE log_level AS ENUM ('debug', 'info', 'warning', 'error', 'critical');

CREATE TABLE system_logs (
    id SERIAL PRIMARY KEY,
    timestamp TIMESTAMPTZ NOT NULL,
    level log_level NOT NULL,
    component VARCHAR(100) NOT NULL,
    message TEXT NOT NULL,
    details JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- Convert to TimescaleDB hypertable
SELECT create_hypertable('system_logs', 'timestamp');

-- Create indexes
CREATE INDEX idx_system_logs_level ON system_logs (level);
CREATE INDEX idx_system_logs_component ON system_logs (component);
CREATE INDEX idx_system_logs_timestamp ON system_logs (timestamp DESC);
```

### 4.7.2 `system_events` Table
Tracks significant system events.

```sql
CREATE TYPE event_type AS ENUM (
    'startup', 'shutdown', 'strategy_change', 'position_opened',
    'position_closed', 'error', 'warning', 'api_failure'
);

CREATE TABLE system_events (
    id SERIAL PRIMARY KEY,
    timestamp TIMESTAMPTZ NOT NULL,
    type event_type NOT NULL,
    component VARCHAR(100) NOT NULL,
    description TEXT NOT NULL,
    details JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- Convert to TimescaleDB hypertable
SELECT create_hypertable('system_events', 'timestamp');

-- Create indexes
CREATE INDEX idx_system_events_type ON system_events (type);
CREATE INDEX idx_system_events_component ON system_events (component);
CREATE INDEX idx_system_events_timestamp ON system_events (timestamp DESC);
```

## 4.8 Retention Policies

For optimal database performance, set up TimescaleDB retention policies for time-series data:

```sql
-- Keep detailed OHLCV data for 1 year, then downsample to lower resolution
SELECT add_retention_policy('candlesticks', INTERVAL '1 year');

-- Keep order book snapshots for 3 months
SELECT add_retention_policy('order_book_snapshots', INTERVAL '3 months');

-- Keep technical indicators for 1 year
SELECT add_retention_policy('technical_indicators', INTERVAL '1 year');

-- Keep system metrics for 6 months
SELECT add_retention_policy('system_metrics', INTERVAL '6 months');

-- Keep system logs for 1 month
SELECT add_retention_policy('system_logs', INTERVAL '1 month');
```

## 4.9 Materialized Views

Create materialized views for frequently accessed data patterns:

```sql
-- Daily OHLCV aggregation for longer-term analysis
CREATE MATERIALIZED VIEW daily_ohlcv AS
SELECT
    symbol,
    time_bucket('1 day', timestamp) AS day,
    first(open, timestamp) AS open,
    max(high) AS high,
    min(low) AS low,
    last(close, timestamp) AS close,
    sum(volume) AS volume
FROM candlesticks
WHERE timeframe = '1m'
GROUP BY symbol, day
ORDER BY day DESC;

-- Create index on materialized view
CREATE INDEX idx_daily_ohlcv_symbol_day ON daily_ohlcv (symbol, day DESC);

-- Set up automatic refresh
SELECT add_continuous_aggregate_policy('daily_ohlcv',
    start_offset => INTERVAL '3 days',
    end_offset => INTERVAL '1 hour',
    schedule_interval => INTERVAL '1 day');
```

## 4.10 Database Backup Strategy

Implement an automated backup strategy:

1. Full daily backups (retained for 30 days)
2. Incremental hourly backups (retained for 7 days)
3. Write-ahead log (WAL) archiving for point-in-time recovery
4. Regular backup validation tests

Backup script should handle:
- Compression of backup files
- Encryption of sensitive data
- Transfer to secure off-site storage
- Rotation of old backups
- Notification on backup success/failure 